#!/usr/bin/make -f

DEB_PYTHON_SYSTEM = pysupport

# Must be included before python-distutils.mk to use dh_python/dh_pysupport.
include /usr/share/cdbs/1/rules/debhelper.mk

include /usr/share/cdbs/1/rules/utils.mk

# Use Python distutils to install the package.
include /usr/share/cdbs/1/class/python-distutils.mk

# Must come after python-distutils.mk.
DEB_PYTHON_SETUP_CMD := tv/linux/setup.py

# The default argument is '-a', which Miro's setup.py doesn't seem to support.
DEB_PYTHON_CLEAN_ARGS := 

# Install everything into debian/tmp, as we have a multi-binary package.
DEB_DH_INSTALL_SOURCEDIR := debian/tmp

# Reduce the number of unneeded dependencies with --as-needed.
LDFLAGS += "-Wl,--as-needed"

# Workaround for a cdbs issue/bug, see #525436.
common-binary-arch common-binary-indep:: miro-fixup
miro-fixup: install/miro

binary-post-install/miro::
	@# Add a few more READMEs.
	cp tv/linux/README debian/miro/usr/share/doc/miro/README.linux
	cp tv/lib/frontends/cli/README debian/miro/usr/share/doc/miro/README.cli

binary-post-install/miro::
	@# Remove unneeded files from the miro deb.
	rm -rf debian/miro/usr/share/pyshared/miro/test

binary-install/miro::
	@# Fixup shebangs.
	sed -i -e '1 s,#!.*python.*,#! /usr/bin/python,' debian/miro/usr/bin/*

binary-post-install/miro-data::
	@# Remove unneeded files from the miro-data deb.
	rm -rf debian/miro-data/usr/share/miro/resources/testdata

clean::
	cd tv/linux && ./clean.sh
	rm -f lib/frontends/widgets/infolist/infolist.c
	rm -f lib/frontends/widgets/gtk/webkitgtkhacks.c
	rm -f lib/frontends/widgets/gtk/pygtkhacks.c
	rm -f linux/plat/xlibhelper.c
	rm -f linux/miro.1.gz
	rm -f linux/miro.real.1.gz

# For /usr/share/cdbs/1/rules/utils.mk sanity check.
common-binary-post-install-arch:: list-missing

