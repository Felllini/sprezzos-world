#!/usr/bin/make -f

SHELL = /bin/sh

ifndef PERL
PERL = /usr/bin/perl
endif

TMP     = `pwd`/debian/`dh_listpackages`
package = eperl

include /usr/share/quilt/quilt.make

build: build-arch build-indep
build-arch: build-stamp
build-indep: build-stamp
build-stamp: $(QUILT_STAMPFN)
	dh_testdir
	cp -p eperl.1 eperl.1.build-backup
	./configure --prefix=/usr $(shell dpkg-buildflags --export=configure)
	#  Remove unneeded library flags
	perl -pi -e 's/ -l\S*db\S*//g' Makefile config.status config_sc.h
	$(MAKE)

	dh_auto_test
	mv Makefile Makefile.stand-alone

	$(PERL) Makefile.PL INSTALLDIRS=vendor
	$(MAKE) LD_RUN_PATH=
	dh_auto_test
	touch build-stamp

clean: unpatch
	dh_testdir
	dh_testroot
	rm -f build-stamp
	test ! -f Makefile             || $(MAKE)                         distclean
	test ! -f Makefile.stand       || $(MAKE) -f Makefile.stand       distclean
	test ! -f Makefile.stand-alone || $(MAKE) -f Makefile.stand-alone distclean
	test ! -f mod/Makefile         || ( cd mod ; $(MAKE)              distclean )
	rm -f Makefile.stand*
	find mod -name Makefile -exec rm '{}' ';'
	find mod -name Makefile.old -exec rm '{}' ';'
	test ! -e eperl.1 -a -e eperl.1.build-backup && mv eperl.1.build-backup eperl.1 || true
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs usr/share/perl5

	# Install eperl binary (no idea why DESTDIR= or PREFIX= don't work here)
	$(MAKE) -f Makefile.stand-alone install prefix=$(TMP)/usr
	# ... and perl modules
	$(MAKE) install DESTDIR=$(TMP)
	# ... and move Apache/ePerl.pm
	mv $(TMP)/usr/lib/perl5/Apache $(TMP)/usr/share/perl5/
	find $(TMP) -type d -empty | xargs -r rmdir -p --ignore-fail-on-non-empty
	rm -rf $(TMP)/usr/lib/eperl

# Build architecture-independent files here.
binary-indep: build
# There are no architecture-independent files to be uploaded
# generated by this package.  If there were any they would be
# made here.

# Build architecture-dependent files here.
binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installdocs ANNOUNCE CREDITS KNOWN.BUGS NEWS PORTING \
		README VERSIONS ChangeLog.* contrib/utils/
	dh_installexamples eg/*
	dh_installchangelogs ChangeLog
	#  Do not provide this link for security reason, see README.Debian
	#dh_link usr/bin/eperl usr/lib/cgi-bin/nph-eperl
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_perl
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install
