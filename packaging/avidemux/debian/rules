#!/usr/bin/make -f

NCPUS := $(shell getconf _NPROCESSORS_ONLN 2>/dev/null || echo 1)

ifeq ($(NCPUS),-1)
	NCPUS:=1
endif

ifeq ($(NCPUS),0)
	NCPUS:=1 
endif

CC := ccache $(CC)
CXX := ccache $(CXX)

CMAKE_SYSTEM_PROCESSOR = $(shell dpkg-architecture -qDEB_BUILD_ARCH)

#SHFLAGS+="-shared -Wl,-soname,$$(@F).2.5.5"

%:
	dh $@ --with quilt --builddirectory=build --buildsystem=cmake

override_dh_auto_configure:
	mkdir -p build/avidemux/ADM_libraries
	cp avidemux/ADM_libraries/ffmpeg-0.9.tar.bz2 build/avidemux/ADM_libraries

	cd build && CC="$(CC)" CXX="$(CXX)" CFLAGS="$(CFLAGS)" SHFLAGS=$(SHFLAGS) \
	cmake .. -DCMAKE_INSTALL_PREFIX:PATH=/usr -DCMAKE_SKIP_RPATH:BOOL=YES \
	-DCMAKE_C_FLAGS:STRING="$(shell dpkg-buildflags --get CPPFLAGS)"

#	-DVERBOSE=on

#	exit 1

override_dh_auto_build:
	cd build && CC="$(CC)" CXX="$(CXX)" CFLAGS="$(CFLAGS)" $(MAKE) ffmpeg -j $(NCPUS)
	cd build && CC="$(CC)" CXX="$(CXX)" CFLAGS="$(CFLAGS)" $(MAKE) -j $(NCPUS)

	cd build/lib && find ../avidemux -name '*.so*' | xargs ln -sft .

	mkdir plugins/build
	cd plugins/build && CC="$(CC)" CXX="$(CXX)" CFLAGS="$(CFLAGS)" \
	cmake -DAVIDEMUX_SOURCE_DIR=$(CURDIR) \
	-DAVIDEMUX_CORECONFIG_DIR=$(CURDIR)/build/config \
	-DAVIDEMUX_INSTALL_PREFIX=$(CURDIR)/build \
	-DCMAKE_C_FLAGS:STRING="$(shell dpkg-buildflags --get CPPFLAGS)" \
	-DCMAKE_INSTALL_PREFIX:PATH=/usr ..

#	exit 1

	cd plugins/build && $(MAKE) -j $(NCPUS)


override_dh_clean:
#	rm -rf build
	rm -rf plugins/build
	rm -rf CMakeFiles
	rm -rf avidemux/ADM_libraries/ffmpeg

	dh_clean client_state.xml

override_dh_install:
	rm -rf debian/tmp/usr/bin/i18n

	for i in 16 22 24 32 36 48; do \
	    mkdir -p debian/tmp/usr/share/icons/hicolor/$${i}x$${i}/apps || exit 1; \
	    convert avidemux_icon.png -resize $$i \
	    debian/tmp/usr/share/icons/hicolor/$${i}x$${i}/apps/avidemux.png || exit 1; \
	done

	# now install the plugins.
	cd $(CURDIR)/plugins/build/ && \
	$(MAKE) install DESTDIR=$(CURDIR)/debian/tmp

	rm debian/tmp/usr/share/ADM_addons/avsfilter/pipe_source.dll
	rm debian/tmp/usr/share/ADM_addons/avsfilter/avsload.exe

	dh_install --fail-missing

override_dh_makeshlibs:
	dh_makeshlibs -a -V

override_dh_builddeb:
	dh_builddeb -- -Zxz
