#!/bin/sh

# Build the current version of a recipe, as specified by the file
# debian/changelog (and output by the Version: line of rapt-parsechangelog(1)).
# If the file recipe_version.orig.tar.{gz|bzip2|xz} is not present, an attempt
# will be made to acquire it using uscan(1). The build will take place in the
# directory recipe_version/. If this directory already exists, it will be
# removed. The directory packagaing/recipe/debian/ must exist; it will be
# copied to recipe_version/debian/ after creating recipe_version/.

set -e

usage () { echo "usage: `basename $0` recipe" ; return 0 ; }
usageerr () { usage >&2 ; return 1 ; }

[ $# -eq 1 ] || usageerr
[ -d "packaging/$1" ] || { echo "packaging/$1 does not exist, or is not a directory" >&2 ; usageerr ; }
cd "packaging/$1"
VERSION="`rapt-parsechangelog | grep ^Version:\  | cut -d\  -f2 | cut -d- -f1`"
cd -
echo -n "Creating directory $1_$VERSION..."
if ! mkdir "$1_$VERSION" ; then
	echo -n "Removing directory $1_$VERSION..."
	rm -rf "$1_$VERSION" || true
	echo
	echo -n "Attempting to create directory $1_$VERSION..."
	mkdir "$1_$VERSION"
fi
cp -r "packaging/$1/debian" "$1_$VERSION"
cd "$1_$VERSION"
TMP="`tempfile`"

cleanup () {
	echo -n "Cleaning... "
	rm -fv "$TMP"
	cd ..
}

trap cleanup EXIT

uscan --force-download --dehs | tee "$TMP"
UVERSION="`xmlstarlet sel -t -v //upstream-version $TMP`"
VERSION="`xmlstarlet sel -t -v //debian-mangled-uversion $TMP`"
if [ "$VERSION" != "$UVERSION" ] ; then
	echo "$VERSION != $UVERSION, aborting!" >&2
	exit 1
fi
echo "Downloaded version $VERSION"
if [ -f "../$1_$VERSION.orig.tar.gz" ] ; then
	tar xzvf "../$1_$VERSION.orig.tar.gz" --strip-components=1
elif [ -f "../$1_$VERSION.orig.tar.bz2" ] ; then
	tar xjvf "../$1_$VERSION.orig.tar.bz2" --strip-components=1
elif [ -f "../$1_$VERSION.orig.tar.xz" ] ; then
	tar xJvf "../$1_$VERSION.orig.tar.xz" --strip-components=1
fi
rm -rf debian
cp -r "../packaging/$1/debian" .
debuild -j8 -k$DEBKEY
